vars:
  TokenUrl: https://fp-dev.urbn.com/api/token/v0
  CheckoutUrl: https://fp-dev.urbn.com/api/checkout/v0
  Site: fp-us
  Channel: web
  Currency: USD
  Language: en-US
  UserEmail: testify@mailinator.com
  ShippingParams: country=US&region=PA
  CreditCardNumber: 341111597242000
  CreditCardYear: 2022
  CreditCardMonth: 12
imports:
  PostToCarts: test_scripts/post_to_carts.yaml
steps:
  -
    name: HealthCheck
    method: GET
    url: "{{.TokenUrl}}"
    url_pattern: "health"
    resp_values:
      json:
        GitBranch: gitBranch
    expectations:
      -
        type: status
        arguments:
          - 200
        fatal: true
      -
        type: string_equals
        arguments:
          - master
          - GitBranch
        fatal: false
  -
    name: GetAToken
    method: POST
    url: "{{.TokenUrl}}"
    headers:
      X-Urbn-Channel: "{{.Channel}}"
      X-Urbn-Currency: "{{.Currency}}"
      X-Urbn-language: "{{.Language}}"
    url_pattern: "{{.Site}}/auth"
    resp_values:
      json:
        Token: authToken
        ReAuthToken: reAuthToken
    expectations:
      - type: status
        arguments:
          - 200
        fatal: true
    actions:
      - type: print
        arguments:
          - Token
  -
    name: AddToCart
    method: POST
    url: "{{.CheckoutUrl}}"
    headers:
      Authorization: "Bearer {{.Token}}"
      X-Urbn-Channel: "{{.Channel}}"
      X-Urbn-Currency: "{{.Currency}}"
      X-Urbn-language: "{{.Language}}"
    url_pattern: "{{.Site}}/carts/items"
    body: |+
          {
               "cartType": "TRANSACTIONAL",
               "multiLine": false,
               "quantity": 1,
               "poolId": "GB_DIRECT",
               "skuId": "45921137",
               "productId": "FP-45920915-000",
               "analytics": {
                   "navigationId": "dyrectray-TopProducts"
               }
           }
    resp_values:
      json:
        ItemId: id
        CartId: cartId
    expectations:
      - type: status
        arguments:
          - 201
        fatal: true
    actions:
      - type: print
        arguments:
          - ItemId
          - CartId
  -
    name: GetCartItems
    method: GET
    url: "{{.CheckoutUrl}}"
    headers:
      Authorization: "Bearer {{.Token}}"
      X-Urbn-Channel: "{{.Channel}}"
      X-Urbn-Currency: "{{.Currency}}"
      X-Urbn-language: "{{.Language}}"
    url_pattern: "{{.Site}}/carts/items"
    resp_values:
      json:
        ItemId: id
        Cart: cart
    expectations:
      - type: status
        arguments:
          - 200
        fatal: true
    actions:
      - type: print
        arguments:
          - Cart
  -
    import: PostToCarts
  -
    name: Add Anon user to Cart
    method: POST
    url: "{{.CheckoutUrl}}"
    headers:
      Authorization: "Bearer {{.Token}}"
      X-Urbn-Channel: "{{.Channel}}"
      X-Urbn-Currency: "{{.Currency}}"
      X-Urbn-language: "{{.Language}}"
    url_pattern: "{{.Site}}/carts/users"
    body: |+
      {
        "email": "{{.UserEmail}}"
      }
    expectations:
      - type: status
        arguments:
          - 204
        fatal: true
  -
    name: Add Shipping Address
    method: POST
    url: "{{.CheckoutUrl}}"
    headers:
      Authorization: "Bearer {{.Token}}"
      X-Urbn-Channel: "{{.Channel}}"
      X-Urbn-Currency: "{{.Currency}}"
      X-Urbn-language: "{{.Language}}"
    url_pattern: "{{.Site}}/carts/buckets/{{.BucketId}}/addresses"
    body: |+
      {
        "city": "Philadelphia",
        "name": {
          "last": "John",
          "first": "Roszkowski"
        },
        "address1": "1132 E Hewson St",
        "phoneNumber": "2153332323",
        "country": "US",
        "postalCode": "19112",
        "region": "PA"
      }
    resp_values:
      json:
        AddressId: addressId
    expectations:
      - type: status
        arguments:
          - 201
        fatal: true
    actions:
      - type: print
        arguments:
          - AddressId
  -
    import: PostToCarts
  -
    name: GetAvailableShipMethods
    method: GET
    url: "{{.CheckoutUrl}}"
    headers:
      Authorization: "Bearer {{.Token}}"
      X-Urbn-Channel: "{{.Channel}}"
      X-Urbn-Currency: "{{.Currency}}"
      X-Urbn-language: "{{.Language}}"
    url_pattern: "{{.Site}}/carts/shipping-methods?{{.ShippingParams}}"
    resp_values:
      json:
        ShipMethodId: "{{.BucketId}}.0.id"
    expectations:
      - type: status
        arguments:
          - 200
        fatal: true
    actions:
      - type: print
        arguments:
          - ShipMethodId
  -
    name: AddShipMethod
    method: POST
    url: "{{.CheckoutUrl}}"
    headers:
      Authorization: "Bearer {{.Token}}"
      X-Urbn-Channel: "{{.Channel}}"
      X-Urbn-Currency: "{{.Currency}}"
      X-Urbn-language: "{{.Language}}"
    url_pattern: "{{.Site}}/carts/buckets/{{.BucketId}}/shipping-methods"
    body: |+
      {
        "shippingMethod": "{{.ShipMethodId}}"
      }
    expectations:
      - type: status
        arguments:
          - 201
        fatal: true
  -
    import: PostToCarts
  -
    name: AddCrefitCardPayment
    method: POST
    url: "{{.CheckoutUrl}}"
    headers:
      Authorization: "Bearer {{.Token}}"
      X-Urbn-Channel: "{{.Channel}}"
      X-Urbn-Currency: "{{.Currency}}"
      X-Urbn-language: "{{.Language}}"
    url_pattern: "{{.Site}}/carts/payments"
    body: |+
      {
        "paymentType": "CREDIT_CARD",
        "creditCard": {
          "expirationMonth": "{{.CreditCardMonth}}",
          "cardType": "AMEX",
          "expirationYear": "{{.CreditCardYear}}",
          "cardNumber": "{{.CreditCardNumber}}",
          "addressId": "{{.AddressId}}"
        }
      }
    resp_values:
      json:
        PaymentId: id
    expectations:
      - type: status
        arguments:
          - 201
        fatal: true
    actions:
      - type: print
        arguments:
          - PaymentId
  -
    import: PostToCarts
  -
    name: SubmitOrder
    method: POST
    url: "{{.CheckoutUrl}}"
    headers:
      Authorization: "Bearer {{.Token}}"
      X-Urbn-Channel: "{{.Channel}}"
      X-Urbn-Currency: "{{.Currency}}"
      X-Urbn-language: "{{.Language}}"
    url_pattern: "{{.Site}}/orders"
    body: |+
      {
        "iovationBlackBox": "XkBlHA1FfwWpaHcKDFrapYBo8JGxC5Z7J1hNC57nL7Q=",
        "customerIpAddress": "10.27.10.22",
        "verificationCode": "1154"
      }
    expectations:
      - type: status
        arguments:
          - 201
        fatal: true
    actions:
      - type: print_response


test_name: "tavern test server tests"
vars:
  Url: http://localhost:5000
stages:
  -
    name: public page access
    request:
      method: GET
      url: "{{.Url}}"
      url_pattern: ""
    response:
      expectations:
        - type: status
          arguments:
            - 200
          fatal: true
      actions:
        - type: print_response
  -
    name: Get a number not logged in yet
    request:
      method: GET
      url: "{{.Url}}"
      url_pattern: "numbers"
    headers:
      Content-Type: "application/json"
    response:
      expectations:
        - type: status
          arguments:
            - 400
          fatal: true
      actions:
        - type: print_response
  -
    name: login
    request:
      method: POST
      url: "{{.Url}}"
      url_pattern: "login"
      headers:
        Content-Type: "application/x-www-form-urlencoded"
      data:
        username: "jon"
        password: "shhh!"
    response:
      expectations:
        - type: status
          arguments:
            - 200
          fatal: true
      resp_values:
        json:
          Token: token
      actions:
        - type: print_response
  -
    name: Get a number that is not in the DB
    request:
      method: GET
      url: "{{.Url}}"
      url_pattern: "numbers"
      headers:
        Authorization: Bearer {{.Token}}
        Content-Type: "application/json"
      json:
        name: test1
    response:
      expectations:
        - type: status
          arguments:
            - 404
          fatal: true
      actions:
        - type: print_response
  -
    name: Add a number to the list
    request:
      method: POST
      url: "{{.Url}}"
      url_pattern: "numbers"
      headers:
        Authorization: Bearer {{.Token}}
        Content-Type: "application/json"
      json:
        name: test1
        number: 23
    response:
      expectations:
        - type: status
          arguments:
            - 201
          fatal: true
      actions:
        - type: print_response
  -
    name: Get a number OK
    request:
      method: GET
      url: "{{.Url}}"
      url_pattern: "numbers"
      headers:
        Authorization: Bearer {{.Token}}
        Content-Type: "application/json"
      json:
        name: test1
    response:
      expectations:
        - type: status
          arguments:
            - 200
          fatal: true
      actions:
        - type: print_response